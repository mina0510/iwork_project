<!DOCTYPE html>
<html lang="zh-tw">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <script src="/jQuery/jquery-3.6.0.js"></script>
    <!-- style -->
    <script src="/jQuery/jquery-3.6.0.js"></script>
    <link rel="stylesheet" href="/css/shared/button.css" />
    <link rel="stylesheet" href="/css/shared/background.css" />
    <link rel="stylesheet" href="/css/shared/content2_style.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-wEmeIV1mKuiNpC+IOBjI7aAzPcEZeedi5yW5f2yOq55WWLwNGmvvx4Um1vskeMj0" crossorigin="anonymous">
    <!-- 修改、刪除紐前面圖式 -->
    <link rel="stylesheet" href="https://unpkg.com/bootstrap@3.3.7/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-p34f1UUtsS3wqzfto5wAAmdvj+osOnFyQFpp4Ua3gs/ZVWx6oOypYoCJhGGScy+8"
        crossorigin="anonymous"></script>

</head>

<!-- 新增公告 -->

<body class="zh-tw">
    <div>
        <ul class="nav nav-tabs">
            <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" data-bs-toggle="dropdown" href="#" role="button"
                    aria-expanded="false">帳號管理</a>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="./CMS_6System.html">帳號權限管理</a></li>
                    <li><a class="dropdown-item" href="./CMS_6_1_2.html">新增帳號</a></li>
                </ul>
            </li>
            <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle active" data-bs-toggle="dropdown" href="#" role="button"
                    aria-expanded="false">公告</a>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="./CMS_6_2_1.html">公告紀錄</a></li>
                    <li><a class="dropdown-item  active" href="#">新增公告</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <a class="nav-link " aria-current="page" href="./CMS_6_3_1.html">推播</a>
            </li>
            <li class="nav-item">
                <a class="nav-link " aria-current="page" href="./CMS_6_4_1.html">出勤管理</a>
            </li>
            <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" data-bs-toggle="dropdown" href="#" role="button"
                    aria-expanded="false">點餐系統</a>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="./CMS_6_5_1.html">點餐紀錄</a></li>
                    <li><a class="dropdown-item" href="./CMS_6_5_2.html">設定餐廳</a></li>
                </ul>
            </li>
        </ul>
    </div>
    <div>
        <div class="staffAll">
            <br>
            <div class="application">
                <div>
                    <label><b>主&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;旨：</b></label>&nbsp;&nbsp;
                    <input type="text" class="inputSize" id="annSubject" style="width: 375px;">
                </div>
                <div>
                    <label><b>類&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;型：</b></label>&nbsp;&nbsp;
                    <select name="" id="annType">
                        <option value="1" class="">最新公告</option>
                        <option value="2" class="">公司文件</option>
                    </select>&nbsp;&nbsp;&nbsp;&nbsp;
                </div>
                <div>
                    <label><b>內&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;容：</b></label><br>
                    <textarea id="annText" cols="62" rows="7"></textarea>
                </div>
                <div>
                    <label><b>上架日期：</b></label>&nbsp;&nbsp;
                    <input type="date" class="inputSize" id="annUploadDate">
                </div>
                <div>
                    <label><b>下架日期：</b></label>&nbsp;&nbsp;
                    <input type="date" class="inputSize" id="annRemoveDate">
                </div>
                <div>
                    <ol class="addli">
                        <form id="attachForm" enctype="multipart/form-data">
                            <li>
                                <div>
                                    <label for="">附件1：</label>&nbsp;&nbsp;
                                    <input id="attachInput1" type="file" class="sendimgbtn"
                                        accept="image/*,.pdf,.doc,.docx,.xml,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document"
                                        style="display: inline-block;">
                                </div>
                            </li>
                            <li>
                                <div>
                                    <label for="">附件2：</label>&nbsp;&nbsp;
                                    <input id="attachInput2" type="file" class="sendimgbtn"
                                        accept="image/*,.pdf,.doc,.docx,.xml,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document"
                                        style="display: inline-block;">
                                </div>
                            </li>
                            <li>
                                <div>
                                    <label for="">附件3：</label>&nbsp;&nbsp;
                                    <input id="attachInput3" type="file" class="sendimgbtn"
                                        accept="image/*,.pdf,.doc,.docx,.xml,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document"
                                        style="display: inline-block;">
                                </div>
                            </li>

                        </form>

                    </ol>
                </div>
                <div>
                    <button id="btnAdd" class="function">+</button>
                </div>
                <br>
                <div>
                    <input type="submit" value="確定" class="btnStyle"
                        id="annFinishBtn"></input>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    <input type="button" value="取消" class="btnStyle" id="cancelbtn"></input>
                </div>
            </div>
        </div>
    </div>

    <script>
        var i = 3;
        btnAdd.onclick = function () {
            if (i < 5) {
                i = i + 1;
                $(".addli").append(`<li><div><label for="">附件${i}：</label>&nbsp;&nbsp;&nbsp;<input id="attachInput${i}"  name="attachInput" type="file" multiple class="sendimgbtn"
                                    accept="image/*,.pdf,.doc,.docx,.xml,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document"
                                    style="display: inline-block;"></div></li>`);
            } else {
                alert("只能傳五個檔案")
            }
        }

        $("#cancelbtn").on("click", function () {
            var yes = confirm("你確定取消嗎?");
            if (yes) {
                window.location.href = './CMS_6_2_1.html';
            } else {
                console.log("取消")
            }
        })

        function getCookie() {
            var cookie = document.cookie.split('=');
            return cookie[1].toString();
        }

        $("#annFinishBtn").click(function () {
            var date = new Date();
            //主旨不能為空
            if ($("#annSubject").val() != "") {
                //下架日期需要大於上架日期 且不能為空
                if ($("#annRemoveDate").val() < $("#annUploadDate").val() ||
                    $("#annRemoveDate").val() == "" ||
                    $("#annUploadDate").val() == "") {
                    alert("請確認時間正確")
                } else {
                    var annData = JSON.stringify({
                        title: $("#annSubject").val(),
                        type: $("#annType").find("option:selected").text(),
                        uploadDate: $("#annUploadDate").val(),
                        removed: $("#annRemoveDate").val(),
                        content: $("#annText").val(),
                        userToken: getCookie()
                    });

                    $.ajax({
                        type: "post",
                        url: "/Announcement/addAnn",
                        data: annData,
                        contentType: "application/json",
                        dataType: "json",
                        success: function (data) {
                            //要回傳公告id
                            var annId = data.annId;

                            var formData = new FormData();
                            formData.append('annId', annId);
                            formData.append('userToken', getCookie());
                            var askLength = 6;
                            var sendAttachorNot = true;
                            if ($(`#attachInput5`).val() == undefined) {
                                askLength = 5;
                            }
                            if ($(`#attachInput4`).val() == undefined) {
                                askLength = 4;
                            }
                            if ($(`#attachInput1`).val() == "") {
                                sendAttachorNot = false;
                            }
                            while (sendAttachorNot) {
                                for (i = 1; i < askLength; i++) {
                                    formData.append('file[]', $(`#attachInput${i}`).get(0).files[0]);
                                }
                                break;
                            }

                            if (sendAttachorNot) {
                                $.ajax({
                                    type: "POST",
                                    url: "/Announcement/uploadAttach",
                                    data: formData,
                                    cache: false,
                                    processData: false,
                                    contentType: false,
                                    success: function (data) {
                                        alert("上傳成功");
                                        window.location.href = "./CMS_6_2_1.html";
                                    },
                                    error: function (data) {
                                        alert("上傳失敗，請確認檔案格式");
                                    }
                                });
                            } else {
                                alert("上傳成功");
                                window.location.href = "./CMS_6_2_1.html";
                            }
                        }
                    });

                }
            } else {
                alert("請填寫主旨");
            }
        });


    </script>
</body>

</html>